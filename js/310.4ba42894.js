"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[310],{25362:function(e,t,s){s.r(t),s.d(t,{default:function(){return j}});var a=s(56768),l=s(24232),i=s.p+"img/file.360cc309.svg";const o={class:"kb-header"},n={class:"kb-stats"},r={class:"create-kb-content"},d={class:"kb-card dashed-border"},c={class:"kb-card-header"},u={class:"kb-card-title-row"},p={class:"kb-card-title"},h={class:"kb-card-actions"},k={class:"kb-card-description"},g={class:"kb-card-footer"},m={class:"create-time"},f={style:{"text-align":"right","margin-top":"20px"}},b={class:"file-container"},C={class:"file-card"},w={class:"file-details"},F={class:"file-title"},v=["onClick"],x={class:"file-info"},y={class:"upload-time"},L={class:"file-size"},_={key:0,class:"chunks-preview"},R={class:"chunks-grid"},T=["onClick"],K={class:"chunk-square-content"},D={key:0,class:"chunk-number"},V={class:"chunk-expanded-header"},I={class:"chunk-length"},$={class:"chunk-expanded-content"},P={class:"upload-card",style:{"border-bottom":"none"}},S={class:"upload-progress-text"};function U(e,t,s,U,A,E){const X=(0,a.g2)("Plus"),B=(0,a.g2)("el-icon"),z=(0,a.g2)("el-col"),M=(0,a.g2)("SvgIcon"),W=(0,a.g2)("el-tooltip"),q=(0,a.g2)("el-row"),j=(0,a.g2)("el-input"),H=(0,a.g2)("el-form-item"),O=(0,a.g2)("el-form"),G=(0,a.g2)("el-button"),N=(0,a.g2)("CustomDialog"),Q=(0,a.g2)("el-scrollbar"),Z=(0,a.g2)("upload-filled"),J=(0,a.g2)("el-progress"),Y=(0,a.g2)("el-upload");return(0,a.uX)(),(0,a.CE)("div",null,[(0,a.bF)(q,{gutter:24,justify:"center",style:{"margin-left":"0","margin-right":"0"}},{default:(0,a.k6)((()=>[(0,a.bF)(z,{md:22,sm:22,xs:22},{default:(0,a.k6)((()=>[(0,a.Lk)("div",o,[t[6]||(t[6]=(0,a.Lk)("h4",null,"知识库",-1)),(0,a.Lk)("div",n,[(0,a.Lk)("span",null,"总文件数: "+(0,l.v_)(E.totalFiles),1),(0,a.Lk)("span",null,"总分段数: "+(0,l.v_)(E.totalChunks),1)])]),(0,a.bF)(q,{gutter:24},{default:(0,a.k6)((()=>[(0,a.bF)(z,{xs:24,sm:12,md:8,lg:8,xl:6},{default:(0,a.k6)((()=>[(0,a.Lk)("div",{class:"kb-card create-kb-card",onClick:t[0]||(t[0]=e=>A.createRepoDialogVisible=!0)},[(0,a.Lk)("div",r,[(0,a.bF)(B,{size:40},{default:(0,a.k6)((()=>[(0,a.bF)(X)])),_:1}),t[7]||(t[7]=(0,a.Lk)("span",{class:"create-text"},"创建知识库",-1))])])])),_:1}),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(E.repos,(e=>((0,a.uX)(),(0,a.Wv)(z,{xs:24,sm:12,md:8,lg:8,xl:6,key:e.repoId},{default:(0,a.k6)((()=>[(0,a.Lk)("div",d,[(0,a.Lk)("div",c,[(0,a.Lk)("div",u,[(0,a.Lk)("span",p,(0,l.v_)(e.name),1),(0,a.Lk)("div",h,[(0,a.bF)(W,{content:"管理",placement:"top"},{default:(0,a.k6)((()=>[(0,a.bF)(M,{"icon-class":"settings",style:{width:"16px",height:"16px"},onClick:t=>E.openRepo(e),class:"action-icon settings"},null,8,["onClick"])])),_:2},1024),(0,a.bF)(W,{content:"删除",placement:"top"},{default:(0,a.k6)((()=>[(0,a.bF)(M,{"icon-class":"trash",style:{width:"16px",height:"16px"},onClick:t=>E.deleteRepo(e.repoId),class:"action-icon delete"},null,8,["onClick"])])),_:2},1024)])])]),(0,a.Lk)("p",k,(0,l.v_)(e.description),1),(0,a.Lk)("div",g,[(0,a.Lk)("span",m,"创建时间: "+(0,l.v_)(e.createTime),1)])])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1}),(0,a.bF)(N,{modelValue:A.createRepoDialogVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>A.createRepoDialogVisible=e),title:"知识库详情"},{default:(0,a.k6)((()=>[(0,a.bF)(O,{model:A.newKbForm,"label-width":"100px",rules:A.rules,ref:"newKbForm"},{default:(0,a.k6)((()=>[(0,a.bF)(H,{label:"知识库名称",prop:"name"},{default:(0,a.k6)((()=>[(0,a.bF)(j,{modelValue:A.newKbForm.name,"onUpdate:modelValue":t[1]||(t[1]=e=>A.newKbForm.name=e),maxlength:"10","show-word-limit":""},null,8,["modelValue"])])),_:1}),(0,a.bF)(H,{label:"知识库描述",prop:"description"},{default:(0,a.k6)((()=>[(0,a.bF)(j,{type:"textarea",modelValue:A.newKbForm.description,"onUpdate:modelValue":t[2]||(t[2]=e=>A.newKbForm.description=e)},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"]),(0,a.Lk)("div",f,[(0,a.bF)(G,{type:"primary",onClick:E.createRepo},{default:(0,a.k6)((()=>t[8]||(t[8]=[(0,a.eW)("确定")]))),_:1},8,["onClick"]),(0,a.bF)(G,{onClick:t[3]||(t[3]=e=>A.createRepoDialogVisible=!1)},{default:(0,a.k6)((()=>t[9]||(t[9]=[(0,a.eW)("取消")]))),_:1})])])),_:1},8,["modelValue"]),(0,a.bF)(N,{modelValue:A.repoDialogVisible,"onUpdate:modelValue":t[5]||(t[5]=e=>A.repoDialogVisible=e),title:`${A.activeRepo?.name||""} - 文件列表`},{default:(0,a.k6)((()=>[(0,a.Lk)("div",b,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(E.files,(e=>((0,a.uX)(),(0,a.CE)("div",C,[t[10]||(t[10]=(0,a.Lk)("img",{src:i,alt:"File Icon",class:"file-icon"},null,-1)),(0,a.Lk)("div",w,[(0,a.Lk)("div",F,[(0,a.eW)((0,l.v_)(e.name)+" ",1),(0,a.bF)(G,{type:"text",onClick:t=>E.toggleChunks(e)},{default:(0,a.k6)((()=>[(0,a.eW)((0,l.v_)(e.showChunks?"收起分段":"查看分段"),1)])),_:2},1032,["onClick"]),(0,a.Lk)("button",{class:"delete-btn",onClick:t=>E.delFile(e.fileId)},"✕",8,v)]),(0,a.Lk)("div",x,[(0,a.Lk)("span",y,"上传时间: "+(0,l.v_)(e.createTime),1),(0,a.Lk)("span",L,"文件大小: "+(0,l.v_)(E.formatFileSize(e.size)),1)]),e.showChunks?((0,a.uX)(),(0,a.CE)("div",_,[(0,a.Lk)("div",R,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e.list,((t,s)=>((0,a.uX)(),(0,a.CE)("div",{key:s,class:(0,l.C4)(["chunk-square",{expanded:E.isChunkExpanded(e.fileId,s)}]),onClick:t=>E.toggleChunkContent(e.fileId,s)},[(0,a.Lk)("div",K,[E.isChunkExpanded(e.fileId,s)?((0,a.uX)(),(0,a.CE)(a.FK,{key:1},[(0,a.Lk)("div",V,[(0,a.Lk)("span",null,"分段 "+(0,l.v_)(s+1),1),(0,a.Lk)("span",I,(0,l.v_)(t.content.length)+" 字符",1)]),(0,a.Lk)("div",$,[(0,a.bF)(Q,{height:"200px"},{default:(0,a.k6)((()=>[(0,a.eW)((0,l.v_)(t.content),1)])),_:2},1024)])],64)):((0,a.uX)(),(0,a.CE)("div",D,(0,l.v_)(s+1),1))])],10,T)))),128))])])):(0,a.Q3)("",!0)])])))),256)),(0,a.Lk)("div",P,[(0,a.bF)(Y,{class:"upload-button",drag:"","auto-upload":!0,"http-request":E.handleLocalUpload,multiple:"","before-upload":E.beforeUpload,"show-file-list":!1,accept:".pdf,.doc,.docx,.txt"},{tip:(0,a.k6)((()=>t[12]||(t[12]=[(0,a.Lk)("div",{class:"el-upload__tip"}," 目前仅支持5MB以内的PDF/DOC/DOCX/TXT文件上传，请确保文件格式正确 ",-1)]))),default:(0,a.k6)((()=>[A.isUploading?((0,a.uX)(),(0,a.CE)(a.FK,{key:1},[(0,a.bF)(J,{type:"circle",percentage:A.uploadProgress,status:100===A.uploadProgress?"success":""},null,8,["percentage","status"]),(0,a.Lk)("div",S,(0,l.v_)(A.uploadStatusText),1)],64)):((0,a.uX)(),(0,a.CE)(a.FK,{key:0},[(0,a.bF)(B,{class:"el-icon--upload"},{default:(0,a.k6)((()=>[(0,a.bF)(Z)])),_:1}),t[11]||(t[11]=(0,a.Lk)("div",{class:"el-upload__text"}," 将文件拖拽至此处 或 点击上传 ",-1))],64))])),_:1},8,["http-request","before-upload"])])])])),_:1},8,["modelValue","title"])])}s(44114),s(18111),s(61701);var A=s(94086),E=(s(22489),s(64141)),X={addRepo(e){let t=E.A.state.app.kb;t.list.push(e),E.A.dispatch("setKb",t)},delRepo(e){let t=E.A.state.app.kb;t.list=t.list.filter((t=>t.repoId!==e)),E.A.dispatch("setKb",t)},updRepo(e,t){let s=E.A.state.app.kb,a=s.list.findIndex((t=>t.id===e));-1!==a&&(s.list[a]=t,E.A.dispatch("setKb",s))},addFile(e,t){let s=E.A.state.app.kb;console.log(s);let a=s.findRepository(e);a&&(a.addFile(t),E.A.dispatch("setKb",s))},delFile(e,t){let s=E.A.state.app.kb,a=s.findRepository(e);a&&(a.removeFile(t),E.A.dispatch("setKb",s))}},B=s(77402);const z=(0,B.useDefault)(new B.Segment);var M={name:"Kb",data(){return{activeRepo:null,createRepoDialogVisible:!1,newKbForm:{name:"",description:""},rules:{name:[{required:!0,message:"请输入知识库名称",trigger:"blur"}],description:[{required:!0,message:"请输入知识库描述",trigger:"blur"}]},repoDialogVisible:!1,uploadProgress:0,isUploading:!1,uploadStatusText:"",progressTimer:null,fileChunksVisibility:{},expandedChunks:{}}},computed:{repos(){return this.$store.state.app.kb.list},files(){return this.activeRepo?.list||[]},chunkSize(){return this.$store.state.setting.chunk_size},totalFiles(){return this.$store.state.app.kb.statistics.totalFiles},totalChunks(){return this.$store.state.app.kb.statistics.totalChunks}},created(){},methods:{createRepo(){this.$refs.newKbForm.validate((e=>{if(e){const e=new A.LN(Date.now(),this.newKbForm.name,(new Date).toLocaleString(),this.newKbForm.description,[]);X.addRepo(e),this.createRepoDialogVisible=!1,this.newKbForm={name:"",description:""},this.$refs.newKbForm.resetFields()}}))},openRepo(e){this.activeRepo=e,this.repoDialogVisible=!0},deleteRepo(e){this.$confirm("确认要删除吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{X.delRepo(e),this.$notify({title:"成功",message:"删除成功",type:"success"})})).catch((()=>{}))},beforeUpload(e){const t=1024*this.$store.state.setting.kb_file_size*1024;return!(e.size>t)||(this.$notify({title:"错误",message:"失败",type:"error"}),!1)},async handleLocalUpload(e){const t=e.file;this.isUploading=!0,this.uploadProgress=0,this.uploadStatusText="准备上传...";try{const e=setInterval((()=>{if(this.uploadProgress<90){const e=90-this.uploadProgress,t=Math.max(1,Math.floor(.2*e));this.uploadProgress+=t,this.uploadStatusText="正在处理文件..."}}),1e3),s=await this.readFileContent(t);if(!s||""===s.trim())return this.$notify({title:"警告",message:"未识别到文件内容",type:"warning"}),this.isUploading=!1,this.uploadProgress=0,void(this.uploadStatusText="");const a=this.splitContentIntoChunks(s,this.chunkSize);clearInterval(e);const l=new A.ZH(Date.now(),t.name,(new Date).toLocaleString(),t.name.split(".").pop().toLowerCase(),"",t.size,a.map((e=>new A.AA(Date.now(),e,z.doSegment(e.toLowerCase()).map((e=>e.w))))));X.addFile(this.activeRepo.repoId,l),this.uploadProgress=100,this.uploadStatusText="上传完成！",this.$notify({title:"成功",message:"上传完成！",type:"success"}),setTimeout((()=>{this.isUploading=!1,this.uploadProgress=0,this.uploadStatusText=""}),1500)}catch(s){console.error("文件上传失败:",s),this.uploadStatusText="上传失败",this.$notify({title:"错误",message:"上传失败",type:"error"}),setTimeout((()=>{this.isUploading=!1,this.uploadProgress=0,this.uploadStatusText=""}),1500)}},async readFileContent(e){const t=e.name.split(".").pop().toLowerCase();switch(t){case"pdf":return await this.readPdfContent(e);case"doc":case"docx":return await this.readDocContent(e);case"txt":return await this.readTxtContent(e);default:throw new Error("不支持的文件格式")}},readTxtContent(e){return new Promise(((t,s)=>{const a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=e=>s(e),a.readAsText(e,"UTF-8")}))},async readPdfContent(e){return new Promise(((t,a)=>{const l=new FileReader;l.onload=async e=>{try{const a=new Uint8Array(e.target.result),l=await s.e(595).then(s.bind(s,26595));l.GlobalWorkerOptions.workerSrc="/pdfjs-dist@5.2.133/pdf.worker.min.mjs";const i=l.getDocument(a),o=await i.promise;let n="";for(let e=1;e<=o.numPages;e++){const t=await o.getPage(e),s=await t.getTextContent(),a=s.items.map((e=>e.str)).join(" ");n+=a+"\n"}t(n)}catch(l){a(l)}},l.onerror=a,l.readAsArrayBuffer(e)}))},async readDocContent(e){const t=await s.e(195).then(s.t.bind(s,21195,19)),a=await e.arrayBuffer(),l=await t.extractRawText({arrayBuffer:a});return l.value},async delFile(e){try{await this.$confirm("确认删除该文件?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),X.delFile(this.activeRepo.repoId,e),this.$notify({title:"成功",message:"文件删除成功",type:"success"})}catch(t){"cancel"!==t&&(console.error("文件删除失败:",t),this.$notify({title:"错误",message:"文件删除失败",type:"error"}))}},formatFileSize(e){if(!e)return"0 B";const t=1024,s=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(2))+" "+s[a]},splitContentIntoChunks(e,t){const s=[];let a="";const l=e.split(/[。！？.!?]/);for(const i of l)(a+i).length>t?(a&&s.push(a.trim()),a=i):a+=i;return a&&s.push(a.trim()),s},toggleChunks(e){e.showChunks=!e.showChunks},toggleChunkContent(e,t){const s=`${e}-${t}`;this.expandedChunks[s]=!this.expandedChunks[s]},isChunkExpanded(e,t){const s=`${e}-${t}`;return this.expandedChunks[s]}}},W=s(71241);const q=(0,W.A)(M,[["render",U],["__scopeId","data-v-79fff7d2"]]);var j=q}}]);
//# sourceMappingURL=310.4ba42894.js.map