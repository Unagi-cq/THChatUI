"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[947],{35947:function(e,n,t){t.r(n),t.d(n,{fetchAPI:function(){return s},postProcess:function(){return l}});t(44114);var o=t(55965),r=t(64141);const a={llm:"https://api.moonshot.cn/v1/chat/completions",vim:"",igm:""};async function s({prompt:e,history:n,files:t,controller:s,onopen:c,onmessage:l,onclose:d,onerror:u}){const{setting:f}=r.A.state,{model_config:h}=f,{version:p,type:y}=h,g=f.model_list[f.platform].api_key_config.api_key,v=a[y]||a.llm,b=!1,m={method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json"},body:JSON.stringify(i(p,e,n,y,t,b)),signal:s.signal,onopen:c,onmessage:l,onclose:d,onerror:u,openWhenHidden:!0};return await(0,o.y)(v,m)}function i(e,n,t,o,r,a){let s={};switch(o){case"llm":s={model:e,messages:c(n,t),stream:!0};break}return s}function c(e,n){function t(e){const n=[];for(let t=0;t<e.length-1;t++){const o=e[t];n.push({role:"user",content:o.query}),n.push({role:"assistant",content:o.answer})}return n}let o=t(n);return o.push({role:"user",content:e}),o}function l(e){if("[DONE]"===e.data)return{content:""};const n=JSON.parse(e.data).choices[0];return"stop"===n.finish_reason?{content:""}:n.delta.reasoning_content?{reasoning_content:n.delta.reasoning_content}:{content:n.delta.content}}},55965:function(e,n,t){async function o(e,n){const t=e.getReader();let o;while(!(o=await t.read()).done)n(o.value)}function r(e){let n,t,o,r=!1;return function(a){void 0===n?(n=a,t=0,o=-1):n=s(n,a);const i=n.length;let c=0;while(t<i){r&&(10===n[t]&&(c=++t),r=!1);let a=-1;for(;t<i&&-1===a;++t)switch(n[t]){case 58:-1===o&&(o=t-c);break;case 13:r=!0;case 10:a=t;break}if(-1===a)break;e(n.subarray(c,a),o),c=t,o=-1}c===i?n=void 0:0!==c&&(n=n.subarray(c),t-=c)}}function a(e,n,t){let o=i();const r=new TextDecoder;return function(a,s){if(0===a.length)null===t||void 0===t||t(o),o=i();else if(s>0){const t=r.decode(a.subarray(0,s)),i=s+(32===a[s+1]?2:1),c=r.decode(a.subarray(i));switch(t){case"data":o.data=o.data?o.data+"\n"+c:c;break;case"event":o.event=c;break;case"id":e(o.id=c);break;case"retry":const t=parseInt(c,10);isNaN(t)||n(o.retry=t);break}}}}function s(e,n){const t=new Uint8Array(e.length+n.length);return t.set(e),t.set(n,e.length),t}function i(){return{data:"",event:"",id:"",retry:void 0}}t.d(n,{y:function(){return f}});var c=function(e,n){var t={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&n.indexOf(o)<0&&(t[o]=e[o]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)n.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(t[o[r]]=e[o[r]])}return t};const l="text/event-stream",d=1e3,u="last-event-id";function f(e,n){var{signal:t,headers:s,onopen:i,onmessage:f,onclose:p,onerror:y,openWhenHidden:g,fetch:v}=n,b=c(n,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((n,c)=>{const m=Object.assign({},s);let w;function O(){w.abort(),document.hidden||P()}m.accept||(m.accept=l),g||document.addEventListener("visibilitychange",O);let k=d,_=0;function j(){document.removeEventListener("visibilitychange",O),window.clearTimeout(_),w.abort()}null===t||void 0===t||t.addEventListener("abort",(()=>{j(),n()}));const T=null!==v&&void 0!==v?v:window.fetch,E=null!==i&&void 0!==i?i:h;async function P(){var t;w=new AbortController;try{const t=await T(e,Object.assign(Object.assign({},b),{headers:m,signal:w.signal}));await E(t),await o(t.body,r(a((e=>{e?m[u]=e:delete m[u]}),(e=>{k=e}),f))),null===p||void 0===p||p(),j(),n()}catch(s){if(!w.signal.aborted)try{const e=null!==(t=null===y||void 0===y?void 0:y(s))&&void 0!==t?t:k;window.clearTimeout(_),_=window.setTimeout(P,e)}catch(i){j(),c(i)}}}P()}))}function h(e){const n=e.headers.get("content-type");if(!(null===n||void 0===n?void 0:n.startsWith(l)))throw new Error(`Expected content-type to be ${l}, Actual: ${n}`)}}}]);
//# sourceMappingURL=947.232e5fab.js.map