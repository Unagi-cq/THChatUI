"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[801],{7801:function(e,t,n){n.r(t),n.d(t,{fetchAPI:function(){return s},postProcess:function(){return u}});n(44114);var o=n(55965),r=n(64141);const a={llm:"https://open.bigmodel.cn/api/paas/v4/chat/completions",vim:"https://open.bigmodel.cn/api/paas/v4/chat/completions",igm:"https://open.bigmodel.cn/api/paas/v4/images/generations"};async function s({prompt:e,history:t,files:n,controller:s,onopen:c,onmessage:l,onclose:u,onerror:d}){const{setting:p}=r.A.state,{model_config:h}=p,{version:f,type:g}=h,y=p.model_list[p.platform].api_key_config.api_key,m=a[g]||a.llm;if("igm"===g){c({status:200});try{const o=await fetch(m,{method:"POST",headers:{Authorization:`Bearer ${y}`,"Content-Type":"application/json"},body:JSON.stringify(i(f,e,t,g,n,!1))}),r=await o.json();return l(r),void u()}catch(v){return void d(v)}}const b={method:"POST",headers:{Authorization:`Bearer ${y}`,"Content-Type":"application/json"},body:JSON.stringify(i(f,e,t,g,n,!1)),signal:s.signal,onopen:c,onmessage:l,onclose:u,onerror:d,openWhenHidden:!0};return await(0,o.y)(m,b)}function i(e,t,n,o,r,a){let s={};switch(o){case"llm":s={model:e,messages:c(t,n),stream:!0};break;case"vim":s={model:e,messages:l(t,n,r),stream:!0};break;case"igm":s={model:e,prompt:t};break}return s}function c(e,t){function n(e){const t=[];for(let n=0;n<e.length-1;n++){const o=e[n];t.push({role:"user",content:o.query}),t.push({role:"assistant",content:o.answer})}return t}let o=n(t);return o.push({role:"user",content:e}),o}function l(e,t,n){function o(e){const t=[];for(let n=0;n<e.length-1;n++){const o=e[n];t.push({role:"user",content:o.files&&o.files[0]&&o.files[0].base64?[{type:"image_url",image_url:{url:o.files[0].base64}},{type:"text",text:o.query}]:[{type:"text",text:o.query}]}),t.push({role:"assistant",content:[{type:"text",text:o.answer}]})}return t}let r=o(t),a=[];return n&&n.length>0&&n[0].base64&&a.push({type:"image_url",image_url:{url:n[0].base64}}),a.push({type:"text",text:e}),r.push({role:"user",content:a}),r}function u(e){if(e.data[0].url)return{content:e.data[0].url};if("[DONE]"===e.data)return{content:""};const t=JSON.parse(e.data).choices[0];return"stop"===t.finish_reason?{content:""}:t.delta.reasoning_content?{reasoning_content:t.delta.reasoning_content}:{content:t.delta.content}}},55965:function(e,t,n){async function o(e,t){const n=e.getReader();let o;while(!(o=await n.read()).done)t(o.value)}function r(e){let t,n,o,r=!1;return function(a){void 0===t?(t=a,n=0,o=-1):t=s(t,a);const i=t.length;let c=0;while(n<i){r&&(10===t[n]&&(c=++n),r=!1);let a=-1;for(;n<i&&-1===a;++n)switch(t[n]){case 58:-1===o&&(o=n-c);break;case 13:r=!0;case 10:a=n;break}if(-1===a)break;e(t.subarray(c,a),o),c=n,o=-1}c===i?t=void 0:0!==c&&(t=t.subarray(c),n-=c)}}function a(e,t,n){let o=i();const r=new TextDecoder;return function(a,s){if(0===a.length)null===n||void 0===n||n(o),o=i();else if(s>0){const n=r.decode(a.subarray(0,s)),i=s+(32===a[s+1]?2:1),c=r.decode(a.subarray(i));switch(n){case"data":o.data=o.data?o.data+"\n"+c:c;break;case"event":o.event=c;break;case"id":e(o.id=c);break;case"retry":const n=parseInt(c,10);isNaN(n)||t(o.retry=n);break}}}}function s(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function i(){return{data:"",event:"",id:"",retry:void 0}}n.d(t,{y:function(){return p}});var c=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n};const l="text/event-stream",u=1e3,d="last-event-id";function p(e,t){var{signal:n,headers:s,onopen:i,onmessage:p,onclose:f,onerror:g,openWhenHidden:y,fetch:m}=t,b=c(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((t,c)=>{const v=Object.assign({},s);let w;function O(){w.abort(),document.hidden||P()}v.accept||(v.accept=l),y||document.addEventListener("visibilitychange",O);let k=u,x=0;function _(){document.removeEventListener("visibilitychange",O),window.clearTimeout(x),w.abort()}null===n||void 0===n||n.addEventListener("abort",(()=>{_(),t()}));const j=null!==m&&void 0!==m?m:window.fetch,T=null!==i&&void 0!==i?i:h;async function P(){var n;w=new AbortController;try{const n=await j(e,Object.assign(Object.assign({},b),{headers:v,signal:w.signal}));await T(n),await o(n.body,r(a((e=>{e?v[d]=e:delete v[d]}),(e=>{k=e}),p))),null===f||void 0===f||f(),_(),t()}catch(s){if(!w.signal.aborted)try{const e=null!==(n=null===g||void 0===g?void 0:g(s))&&void 0!==n?n:k;window.clearTimeout(x),x=window.setTimeout(P,e)}catch(i){_(),c(i)}}}P()}))}function h(e){const t=e.headers.get("content-type");if(!(null===t||void 0===t?void 0:t.startsWith(l)))throw new Error(`Expected content-type to be ${l}, Actual: ${t}`)}}}]);
//# sourceMappingURL=801.3d4a7164.js.map