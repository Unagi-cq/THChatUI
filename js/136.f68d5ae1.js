"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[136],{55965:function(e,t,n){async function o(e,t){const n=e.getReader();let o;while(!(o=await n.read()).done)t(o.value)}function r(e){let t,n,o,r=!1;return function(a){void 0===t?(t=a,n=0,o=-1):t=i(t,a);const s=t.length;let c=0;while(n<s){r&&(10===t[n]&&(c=++n),r=!1);let a=-1;for(;n<s&&-1===a;++n)switch(t[n]){case 58:-1===o&&(o=n-c);break;case 13:r=!0;case 10:a=n;break}if(-1===a)break;e(t.subarray(c,a),o),c=n,o=-1}c===s?t=void 0:0!==c&&(t=t.subarray(c),n-=c)}}function a(e,t,n){let o=s();const r=new TextDecoder;return function(a,i){if(0===a.length)null===n||void 0===n||n(o),o=s();else if(i>0){const n=r.decode(a.subarray(0,i)),s=i+(32===a[i+1]?2:1),c=r.decode(a.subarray(s));switch(n){case"data":o.data=o.data?o.data+"\n"+c:c;break;case"event":o.event=c;break;case"id":e(o.id=c);break;case"retry":const n=parseInt(c,10);isNaN(n)||t(o.retry=n);break}}}}function i(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function s(){return{data:"",event:"",id:"",retry:void 0}}n.d(t,{y:function(){return f}});var c=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var r=0;for(o=Object.getOwnPropertySymbols(e);r<o.length;r++)t.indexOf(o[r])<0&&Object.prototype.propertyIsEnumerable.call(e,o[r])&&(n[o[r]]=e[o[r]])}return n};const l="text/event-stream",d=1e3,u="last-event-id";function f(e,t){var{signal:n,headers:i,onopen:s,onmessage:f,onclose:p,onerror:y,openWhenHidden:v,fetch:b}=t,g=c(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((t,c)=>{const w=Object.assign({},i);let m;function O(){m.abort(),document.hidden||S()}w.accept||(w.accept=l),v||document.addEventListener("visibilitychange",O);let k=d,j=0;function T(){document.removeEventListener("visibilitychange",O),window.clearTimeout(j),m.abort()}null===n||void 0===n||n.addEventListener("abort",(()=>{T(),t()}));const P=null!==b&&void 0!==b?b:window.fetch,C=null!==s&&void 0!==s?s:h;async function S(){var n;m=new AbortController;try{const n=await P(e,Object.assign(Object.assign({},g),{headers:w,signal:m.signal}));await C(n),await o(n.body,r(a((e=>{e?w[u]=e:delete w[u]}),(e=>{k=e}),f))),null===p||void 0===p||p(),T(),t()}catch(i){if(!m.signal.aborted)try{const e=null!==(n=null===y||void 0===y?void 0:y(i))&&void 0!==n?n:k;window.clearTimeout(j),j=window.setTimeout(S,e)}catch(s){T(),c(s)}}}S()}))}function h(e){const t=e.headers.get("content-type");if(!(null===t||void 0===t?void 0:t.startsWith(l)))throw new Error(`Expected content-type to be ${l}, Actual: ${t}`)}},91136:function(e,t,n){n.r(t),n.d(t,{fetchAPI:function(){return i},postProcess:function(){return l}});n(44114);var o=n(55965),r=n(46387);const a={llm:"/local/chat/stream",vim:"/local/vim/stream",igm:"/local/igm/generate"};async function i({prompt:e,history:t,files:n,controller:i,onopen:c,onmessage:l,onclose:d,onerror:u}){const{setting:f}=r.A.state,{model_config:h,web_search_enabled:p}=f,{version:y,type:v,can_web_search:b}=h,g=a[v]||a.llm,w=void 0!==b&&b&&p;if("igm"===v){c({status:200});try{const o=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s(y,e,t,v,n,!1))}),r=await o.json();return l(r),void d()}catch(m){return void u(m)}}await(0,o.y)(g,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(s(y,e,t,v,n,w)),signal:i.signal,onopen:c,onmessage:l,onclose:d,onerror:u,openWhenHidden:!0})}function s(e,t,n,o,r,a){let i={input:{prompt:t,history:c(n),files:r}};return i}function c(e){const t=[];for(let n=0;n<e.length;n++){const o=e[n];t.push({user:o.query,assistant:o.answer})}return t}function l(e){if("string"===typeof e.data)var t=JSON.parse(e.data);else t=e.data;return t[0]&&t[0].url?{content:t[0].url}:t.data.content?{content:t.data.content}:{content:""}}}}]);
//# sourceMappingURL=136.f68d5ae1.js.map