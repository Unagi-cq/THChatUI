"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[241],{45621:function(e,t,s){s.r(t),s.d(t,{default:function(){return H}});var a=s(56768),l=s(24232),i=s.p+"img/file.360cc309.svg";const o={class:"kb-container standard-page-container"},n={class:"kb-header standard-page-header"},r={class:"kb-stats standard-page-stats"},d={class:"create-kb-content"},c={class:"kb-card"},p={class:"kb-card-header"},u={class:"kb-card-title-row"},h={class:"kb-card-title"},k={class:"kb-card-actions"},g={class:"kb-card-description"},m={class:"kb-card-footer"},f={class:"create-time"},b={style:{"text-align":"right","margin-top":"20px"}},C={class:"file-container"},w={class:"file-card"},F={class:"file-details"},v={class:"file-title"},x=["onClick"],y={class:"file-info"},L={class:"upload-time"},_={class:"file-size"},R={key:0,class:"chunks-preview"},T={class:"chunks-grid"},K=["onClick"],D={class:"chunk-square-content"},V={key:0,class:"chunk-number"},I={class:"chunk-expanded-header"},$={class:"chunk-length"},P={class:"chunk-expanded-content"},S={class:"upload-card"},U={class:"upload-progress-text"};function A(e,t,s,A,E,X){const B=(0,a.g2)("Plus"),z=(0,a.g2)("el-icon"),M=(0,a.g2)("el-col"),W=(0,a.g2)("SvgIcon"),q=(0,a.g2)("el-tooltip"),j=(0,a.g2)("el-row"),H=(0,a.g2)("el-input"),O=(0,a.g2)("el-form-item"),G=(0,a.g2)("el-form"),N=(0,a.g2)("el-button"),Q=(0,a.g2)("CustomDialog"),Z=(0,a.g2)("el-scrollbar"),J=(0,a.g2)("upload-filled"),Y=(0,a.g2)("el-progress"),ee=(0,a.g2)("el-upload");return(0,a.uX)(),(0,a.CE)("div",o,[(0,a.Lk)("div",n,[t[6]||(t[6]=(0,a.Lk)("h4",null,"知识库",-1)),(0,a.Lk)("div",r,[(0,a.Lk)("span",null,"总文件数: "+(0,l.v_)(X.totalFiles),1),(0,a.Lk)("span",null,"总分段数: "+(0,l.v_)(X.totalChunks),1)])]),(0,a.bF)(j,{gutter:24,justify:"center",style:{"margin-left":"0","margin-right":"0"}},{default:(0,a.k6)((()=>[(0,a.bF)(M,{md:24,sm:24,xs:24},{default:(0,a.k6)((()=>[(0,a.bF)(j,{gutter:24},{default:(0,a.k6)((()=>[(0,a.bF)(M,{xs:24,sm:12,md:8,lg:8,xl:6},{default:(0,a.k6)((()=>[(0,a.Lk)("div",{class:"kb-card create-kb-card",onClick:t[0]||(t[0]=e=>E.createRepoDialogVisible=!0)},[(0,a.Lk)("div",d,[(0,a.bF)(z,{size:40},{default:(0,a.k6)((()=>[(0,a.bF)(B)])),_:1}),t[7]||(t[7]=(0,a.Lk)("span",{class:"create-text"},"创建知识库",-1))])])])),_:1}),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(X.repos,(e=>((0,a.uX)(),(0,a.Wv)(M,{xs:24,sm:12,md:8,lg:8,xl:6,key:e.repoId},{default:(0,a.k6)((()=>[(0,a.Lk)("div",c,[(0,a.Lk)("div",p,[(0,a.Lk)("div",u,[(0,a.Lk)("span",h,(0,l.v_)(e.name),1),(0,a.Lk)("div",k,[(0,a.bF)(q,{content:"管理",placement:"top"},{default:(0,a.k6)((()=>[(0,a.bF)(W,{"icon-class":"settings",style:{width:"16px",height:"16px"},onClick:t=>X.openRepo(e),class:"action-icon settings"},null,8,["onClick"])])),_:2},1024),(0,a.bF)(q,{content:"删除",placement:"top"},{default:(0,a.k6)((()=>[(0,a.bF)(W,{"icon-class":"trash",style:{width:"16px",height:"16px"},onClick:t=>X.deleteRepo(e.repoId),class:"action-icon delete"},null,8,["onClick"])])),_:2},1024)])])]),(0,a.Lk)("p",g,(0,l.v_)(e.description),1),(0,a.Lk)("div",m,[(0,a.Lk)("span",f,"创建时间: "+(0,l.v_)(e.createTime),1)])])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1}),(0,a.bF)(Q,{modelValue:E.createRepoDialogVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>E.createRepoDialogVisible=e),title:"知识库详情"},{default:(0,a.k6)((()=>[(0,a.bF)(G,{model:E.newKbForm,"label-width":"100px",rules:E.rules,ref:"newKbForm"},{default:(0,a.k6)((()=>[(0,a.bF)(O,{label:"知识库名称",prop:"name"},{default:(0,a.k6)((()=>[(0,a.bF)(H,{modelValue:E.newKbForm.name,"onUpdate:modelValue":t[1]||(t[1]=e=>E.newKbForm.name=e),maxlength:"10","show-word-limit":""},null,8,["modelValue"])])),_:1}),(0,a.bF)(O,{label:"知识库描述",prop:"description"},{default:(0,a.k6)((()=>[(0,a.bF)(H,{type:"textarea",modelValue:E.newKbForm.description,"onUpdate:modelValue":t[2]||(t[2]=e=>E.newKbForm.description=e)},null,8,["modelValue"])])),_:1})])),_:1},8,["model","rules"]),(0,a.Lk)("div",b,[(0,a.bF)(N,{type:"primary",onClick:X.createRepo},{default:(0,a.k6)((()=>t[8]||(t[8]=[(0,a.eW)("确定")]))),_:1},8,["onClick"]),(0,a.bF)(N,{onClick:t[3]||(t[3]=e=>E.createRepoDialogVisible=!1)},{default:(0,a.k6)((()=>t[9]||(t[9]=[(0,a.eW)("取消")]))),_:1})])])),_:1},8,["modelValue"]),(0,a.bF)(Q,{modelValue:E.repoDialogVisible,"onUpdate:modelValue":t[5]||(t[5]=e=>E.repoDialogVisible=e),title:`${E.activeRepo?.name||""} - 文件列表`},{default:(0,a.k6)((()=>[(0,a.Lk)("div",C,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(X.files,(e=>((0,a.uX)(),(0,a.CE)("div",w,[t[10]||(t[10]=(0,a.Lk)("img",{src:i,alt:"File Icon",class:"file-icon"},null,-1)),(0,a.Lk)("div",F,[(0,a.Lk)("div",v,[(0,a.eW)((0,l.v_)(e.name)+" ",1),(0,a.bF)(N,{type:"text",onClick:t=>X.toggleChunks(e)},{default:(0,a.k6)((()=>[(0,a.eW)((0,l.v_)(e.showChunks?"收起分段":"查看分段"),1)])),_:2},1032,["onClick"]),(0,a.Lk)("button",{class:"delete-btn",onClick:t=>X.delFile(e.fileId)},"✕",8,x)]),(0,a.Lk)("div",y,[(0,a.Lk)("span",L,"上传时间: "+(0,l.v_)(e.createTime),1),(0,a.Lk)("span",_,"文件大小: "+(0,l.v_)(X.formatFileSize(e.size)),1)]),e.showChunks?((0,a.uX)(),(0,a.CE)("div",R,[(0,a.Lk)("div",T,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e.list,((t,s)=>((0,a.uX)(),(0,a.CE)("div",{key:s,class:(0,l.C4)(["chunk-square",{expanded:X.isChunkExpanded(e.fileId,s)}]),onClick:t=>X.toggleChunkContent(e.fileId,s)},[(0,a.Lk)("div",D,[X.isChunkExpanded(e.fileId,s)?((0,a.uX)(),(0,a.CE)(a.FK,{key:1},[(0,a.Lk)("div",I,[(0,a.Lk)("span",null,"分段 "+(0,l.v_)(s+1),1),(0,a.Lk)("span",$,(0,l.v_)(t.content.length)+" 字符",1)]),(0,a.Lk)("div",P,[(0,a.bF)(Z,{height:"200px"},{default:(0,a.k6)((()=>[(0,a.eW)((0,l.v_)(t.content),1)])),_:2},1024)])],64)):((0,a.uX)(),(0,a.CE)("div",V,(0,l.v_)(s+1),1))])],10,K)))),128))])])):(0,a.Q3)("",!0)])])))),256)),(0,a.Lk)("div",S,[(0,a.bF)(ee,{class:"upload-button",drag:"","auto-upload":!0,"http-request":X.handleLocalUpload,multiple:"","before-upload":X.beforeUpload,"show-file-list":!1,accept:".pdf,.doc,.docx,.txt"},{tip:(0,a.k6)((()=>t[12]||(t[12]=[(0,a.Lk)("div",{class:"el-upload__tip"}," 目前仅支持5MB以内的PDF/DOC/DOCX/TXT文件上传，请确保文件格式正确 ",-1)]))),default:(0,a.k6)((()=>[E.isUploading?((0,a.uX)(),(0,a.CE)(a.FK,{key:1},[(0,a.bF)(Y,{type:"circle",percentage:E.uploadProgress,status:100===E.uploadProgress?"success":""},null,8,["percentage","status"]),(0,a.Lk)("div",U,(0,l.v_)(E.uploadStatusText),1)],64)):((0,a.uX)(),(0,a.CE)(a.FK,{key:0},[(0,a.bF)(z,{class:"el-icon--upload"},{default:(0,a.k6)((()=>[(0,a.bF)(J)])),_:1}),t[11]||(t[11]=(0,a.Lk)("div",{class:"el-upload__text"}," 将文件拖拽至此处 或 点击上传 ",-1))],64))])),_:1},8,["http-request","before-upload"])])])])),_:1},8,["modelValue","title"])])}s(44114),s(18111),s(61701);var E=s(94086),X=(s(22489),s(64141)),B={addRepo(e){let t=X.A.state.app.kb;t.list.push(e),X.A.dispatch("setKb",t)},delRepo(e){let t=X.A.state.app.kb;t.list=t.list.filter((t=>t.repoId!==e)),X.A.dispatch("setKb",t)},updRepo(e,t){let s=X.A.state.app.kb,a=s.list.findIndex((t=>t.id===e));-1!==a&&(s.list[a]=t,X.A.dispatch("setKb",s))},addFile(e,t){let s=X.A.state.app.kb;console.log(s);let a=s.findRepository(e);a&&(a.addFile(t),X.A.dispatch("setKb",s))},delFile(e,t){let s=X.A.state.app.kb,a=s.findRepository(e);a&&(a.removeFile(t),X.A.dispatch("setKb",s))}},z=s(77402);const M=(0,z.useDefault)(new z.Segment);var W={name:"Kb",data(){return{activeRepo:null,createRepoDialogVisible:!1,newKbForm:{name:"",description:""},rules:{name:[{required:!0,message:"请输入知识库名称",trigger:"blur"}],description:[{required:!0,message:"请输入知识库描述",trigger:"blur"}]},repoDialogVisible:!1,uploadProgress:0,isUploading:!1,uploadStatusText:"",progressTimer:null,fileChunksVisibility:{},expandedChunks:{}}},computed:{repos(){return this.$store.state.app.kb.list},files(){return this.activeRepo?.list||[]},chunkSize(){return this.$store.state.setting.chunk_size},totalFiles(){return this.$store.state.app.kb.statistics.totalFiles},totalChunks(){return this.$store.state.app.kb.statistics.totalChunks}},created(){},methods:{createRepo(){this.$refs.newKbForm.validate((e=>{if(e){const e=new E.LN(Date.now(),this.newKbForm.name,(new Date).toLocaleString(),this.newKbForm.description,[]);B.addRepo(e),this.createRepoDialogVisible=!1,this.newKbForm={name:"",description:""},this.$refs.newKbForm.resetFields()}}))},openRepo(e){this.activeRepo=e,this.repoDialogVisible=!0},deleteRepo(e){this.$confirm("确认要删除吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{B.delRepo(e),this.$notify({title:"成功",message:"删除成功",type:"success"})})).catch((()=>{}))},beforeUpload(e){const t=1024*this.$store.state.setting.kb_file_size*1024;return!(e.size>t)||(this.$notify({title:"错误",message:"失败",type:"error"}),!1)},async handleLocalUpload(e){const t=e.file;this.isUploading=!0,this.uploadProgress=0,this.uploadStatusText="准备上传...";try{const e=setInterval((()=>{if(this.uploadProgress<90){const e=90-this.uploadProgress,t=Math.max(1,Math.floor(.2*e));this.uploadProgress+=t,this.uploadStatusText="正在处理文件..."}}),1e3),s=await this.readFileContent(t);if(!s||""===s.trim())return this.$notify({title:"警告",message:"未识别到文件内容",type:"warning"}),this.isUploading=!1,this.uploadProgress=0,void(this.uploadStatusText="");const a=this.splitContentIntoChunks(s,this.chunkSize);clearInterval(e);const l=new E.ZH(Date.now(),t.name,(new Date).toLocaleString(),t.name.split(".").pop().toLowerCase(),"",t.size,a.map((e=>new E.AA(Date.now(),e,M.doSegment(e.toLowerCase()).map((e=>e.w))))));B.addFile(this.activeRepo.repoId,l),this.uploadProgress=100,this.uploadStatusText="上传完成！",this.$notify({title:"成功",message:"上传完成！",type:"success"}),setTimeout((()=>{this.isUploading=!1,this.uploadProgress=0,this.uploadStatusText=""}),1500)}catch(s){console.error("文件上传失败:",s),this.uploadStatusText="上传失败",this.$notify({title:"错误",message:"上传失败",type:"error"}),setTimeout((()=>{this.isUploading=!1,this.uploadProgress=0,this.uploadStatusText=""}),1500)}},async readFileContent(e){const t=e.name.split(".").pop().toLowerCase();switch(t){case"pdf":return await this.readPdfContent(e);case"doc":case"docx":return await this.readDocContent(e);case"txt":return await this.readTxtContent(e);default:throw new Error("不支持的文件格式")}},readTxtContent(e){return new Promise(((t,s)=>{const a=new FileReader;a.onload=e=>t(e.target.result),a.onerror=e=>s(e),a.readAsText(e,"UTF-8")}))},async readPdfContent(e){return new Promise(((t,a)=>{const l=new FileReader;l.onload=async e=>{try{const a=new Uint8Array(e.target.result),l=await s.e(595).then(s.bind(s,26595));l.GlobalWorkerOptions.workerSrc="/pdfjs-dist@5.2.133/pdf.worker.min.mjs";const i=l.getDocument(a),o=await i.promise;let n="";for(let e=1;e<=o.numPages;e++){const t=await o.getPage(e),s=await t.getTextContent(),a=s.items.map((e=>e.str)).join(" ");n+=a+"\n"}t(n)}catch(l){a(l)}},l.onerror=a,l.readAsArrayBuffer(e)}))},async readDocContent(e){const t=await s.e(195).then(s.t.bind(s,21195,19)),a=await e.arrayBuffer(),l=await t.extractRawText({arrayBuffer:a});return l.value},async delFile(e){try{await this.$confirm("确认删除该文件?","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),B.delFile(this.activeRepo.repoId,e),this.$notify({title:"成功",message:"文件删除成功",type:"success"})}catch(t){"cancel"!==t&&(console.error("文件删除失败:",t),this.$notify({title:"错误",message:"文件删除失败",type:"error"}))}},formatFileSize(e){if(!e)return"0 B";const t=1024,s=["B","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,a)).toFixed(2))+" "+s[a]},splitContentIntoChunks(e,t){const s=[];let a="";const l=e.split(/[。！？.!?]/);for(const i of l)(a+i).length>t?(a&&s.push(a.trim()),a=i):a+=i;return a&&s.push(a.trim()),s},toggleChunks(e){e.showChunks=!e.showChunks},toggleChunkContent(e,t){const s=`${e}-${t}`;this.expandedChunks[s]=!this.expandedChunks[s]},isChunkExpanded(e,t){const s=`${e}-${t}`;return this.expandedChunks[s]}}},q=s(71241);const j=(0,q.A)(W,[["render",A],["__scopeId","data-v-1f9132e8"]]);var H=j}}]);
//# sourceMappingURL=241.fcf95f5f.js.map