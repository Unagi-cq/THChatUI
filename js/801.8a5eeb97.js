"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[801],{5965:function(e,t,n){n.d(t,{y:function(){return p}});n(6573),n(8100),n(7936),n(7467),n(4732),n(9577);async function o(e,t){const n=e.getReader();let o;while(!(o=await n.read()).done)t(o.value)}function a(e){let t,n,o,a=!1;return function(r){void 0===t?(t=r,n=0,o=-1):t=i(t,r);const s=t.length;let c=0;while(n<s){a&&(10===t[n]&&(c=++n),a=!1);let r=-1;for(;n<s&&-1===r;++n)switch(t[n]){case 58:-1===o&&(o=n-c);break;case 13:a=!0;case 10:r=n;break}if(-1===r)break;e(t.subarray(c,r),o),c=n,o=-1}c===s?t=void 0:0!==c&&(t=t.subarray(c),n-=c)}}function r(e,t,n){let o=s();const a=new TextDecoder;return function(r,i){if(0===r.length)null===n||void 0===n||n(o),o=s();else if(i>0){const n=a.decode(r.subarray(0,i)),s=i+(32===r[i+1]?2:1),c=a.decode(r.subarray(s));switch(n){case"data":o.data=o.data?o.data+"\n"+c:c;break;case"event":o.event=c;break;case"id":e(o.id=c);break;case"retry":const n=parseInt(c,10);isNaN(n)||t(o.retry=n);break}}}}function i(e,t){const n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function s(){return{data:"",event:"",id:"",retry:void 0}}var c=function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"===typeof Object.getOwnPropertySymbols){var a=0;for(o=Object.getOwnPropertySymbols(e);a<o.length;a++)t.indexOf(o[a])<0&&Object.prototype.propertyIsEnumerable.call(e,o[a])&&(n[o[a]]=e[o[a]])}return n};const l="text/event-stream",d=1e3,u="last-event-id";function p(e,t){var{signal:n,headers:i,onopen:s,onmessage:p,onclose:h,onerror:g,openWhenHidden:y,fetch:v}=t,b=c(t,["signal","headers","onopen","onmessage","onclose","onerror","openWhenHidden","fetch"]);return new Promise(((t,c)=>{const m=Object.assign({},i);let w;function O(){w.abort(),document.hidden||C()}m.accept||(m.accept=l),y||document.addEventListener("visibilitychange",O);let k=d,A=0;function j(){document.removeEventListener("visibilitychange",O),window.clearTimeout(A),w.abort()}null===n||void 0===n||n.addEventListener("abort",(()=>{j(),t()}));const T=null!==v&&void 0!==v?v:window.fetch,P=null!==s&&void 0!==s?s:f;async function C(){var n;w=new AbortController;try{const n=await T(e,Object.assign(Object.assign({},b),{headers:m,signal:w.signal}));await P(n),await o(n.body,a(r((e=>{e?m[u]=e:delete m[u]}),(e=>{k=e}),p))),null===h||void 0===h||h(),j(),t()}catch(i){if(!w.signal.aborted)try{const e=null!==(n=null===g||void 0===g?void 0:g(i))&&void 0!==n?n:k;window.clearTimeout(A),A=window.setTimeout(C,e)}catch(s){j(),c(s)}}}C()}))}function f(e){const t=e.headers.get("content-type");if(!(null===t||void 0===t?void 0:t.startsWith(l)))throw new Error(`Expected content-type to be ${l}, Actual: ${t}`)}},7801:function(e,t,n){n.r(t),n.d(t,{fenchStream:function(){return c}});var o=n(5965),a=n(2984),r=n(6387);const i="https://open.bigmodel.cn/api/paas/v4/chat/completions",s="https://open.bigmodel.cn/api/paas/v4/images/generations";async function c({prompt:e,history:t,files:n,controller:c,onopen:l,onmessage:d,onclose:u,onerror:p}){let f=r.A.state.setting.model_config.version,h=r.A.state.setting.model_config.pre_method,g=r.A.state.setting.api_key_map[r.A.state.setting.platform],y="llm"===r.A.state.setting.model_config.type?i:s;if("igm"===r.A.state.setting.model_config.type){l({status:200});try{const o=await fetch(y,{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json"},body:JSON.stringify((0,a.preProcess)(f,e,t,h,n,!1))}),r=await o.json();return d(r),void u()}catch(v){return void p(v)}}await(0,o.y)(y,{method:"POST",headers:{Authorization:`Bearer ${g}`,"Content-Type":"application/json"},body:JSON.stringify((0,a.preProcess)(f,e,t,h,n,!1)),signal:c.signal,onopen:l,onmessage:d,onclose:u,onerror:p,openWhenHidden:!0})}}}]);
//# sourceMappingURL=801.8a5eeb97.js.map