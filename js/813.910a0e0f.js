"use strict";(self["webpackChunkTHChatUI"]=self["webpackChunkTHChatUI"]||[]).push([[813],{625:function(e,t,s){s.r(t),s.d(t,{default:function(){return le}});var o=s(56768),a=s(24232),i=s.p+"img/file.360cc309.svg";const l=e=>((0,o.Qi)("data-v-4ae53a5a"),e=e(),(0,o.jt)(),e),n={class:"kb-header"},r={class:"kb-stats"},d={class:"create-kb-content"},c={class:"create-text"},p={class:"kb-card dashed-border"},u={class:"kb-card-header"},h={class:"kb-card-title-row"},k={class:"kb-card-title"},m={class:"kb-card-actions"},C=["onClick"],b=l((()=>(0,o.Lk)("path",{d:"M15.5 12C15.5 13.933 13.933 15.5 12 15.5C10.067 15.5 8.5 13.933 8.5 12C8.5 10.067 10.067 8.5 12 8.5C13.933 8.5 15.5 10.067 15.5 12Z",stroke:"currentColor","stroke-width":"1.5"},null,-1))),g=l((()=>(0,o.Lk)("path",{d:"M21.011 14.0965C21.5329 13.9558 21.7939 13.8854 21.8969 13.7508C22 13.6163 22 13.3998 22 12.9669V11.0332C22 10.6003 22 10.3838 21.8969 10.2493C21.7938 10.1147 21.5329 10.0443 21.011 9.90358C19.0606 9.37759 17.8399 7.33851 18.3433 5.40087C18.4817 4.86799 18.5509 4.60156 18.4848 4.44529C18.4187 4.28902 18.2291 4.18134 17.8497 3.96596L16.125 2.98673C15.7528 2.77539 15.5667 2.66972 15.3997 2.69222C15.2326 2.71472 15.0442 2.90273 14.6672 3.27873C13.208 4.73448 10.7936 4.73442 9.33434 3.27864C8.95743 2.90263 8.76898 2.71463 8.60193 2.69212C8.43489 2.66962 8.24877 2.77529 7.87653 2.98663L6.15184 3.96587C5.77253 4.18123 5.58287 4.28891 5.51678 4.44515C5.45068 4.6014 5.51987 4.86787 5.65825 5.4008C6.16137 7.3385 4.93972 9.37763 2.98902 9.9036C2.46712 10.0443 2.20617 10.1147 2.10308 10.2492C2 10.3838 2 10.6003 2 11.0332V12.9669C2 13.3998 2 13.6163 2.10308 13.7508C2.20615 13.8854 2.46711 13.9558 2.98902 14.0965C4.9394 14.6225 6.16008 16.6616 5.65672 18.5992C5.51829 19.1321 5.44907 19.3985 5.51516 19.5548C5.58126 19.7111 5.77092 19.8188 6.15025 20.0341L7.87495 21.0134C8.24721 21.2247 8.43334 21.3304 8.6004 21.3079C8.76746 21.2854 8.95588 21.0973 9.33271 20.7213C10.7927 19.2644 13.2088 19.2643 14.6689 20.7212C15.0457 21.0973 15.2341 21.2853 15.4012 21.3078C15.5682 21.3303 15.7544 21.2246 16.1266 21.0133L17.8513 20.034C18.2307 19.8187 18.4204 19.711 18.4864 19.5547C18.5525 19.3984 18.4833 19.132 18.3448 18.5991C17.8412 16.6616 19.0609 14.6226 21.011 14.0965Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"},null,-1))),f=[b,g],w=["onClick"],v=l((()=>(0,o.Lk)("path",{d:"M19.5 5.5L18.8803 15.5251C18.7219 18.0864 18.6428 19.3671 18.0008 20.2879C17.6833 20.7431 17.2747 21.1273 16.8007 21.416C15.8421 22 14.559 22 11.9927 22C9.42312 22 8.1383 22 7.17905 21.4149C6.7048 21.1257 6.296 20.7408 5.97868 20.2848C5.33688 19.3626 5.25945 18.0801 5.10461 15.5152L4.5 5.5",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"},null,-1))),$=l((()=>(0,o.Lk)("path",{d:"M3 5.5H21M16.0557 5.5L15.3731 4.09173C14.9196 3.15626 14.6928 2.68852 14.3017 2.39681C14.215 2.3321 14.1231 2.27454 14.027 2.2247C13.5939 2 13.0741 2 12.0345 2C10.9688 2 10.436 2 9.99568 2.23412C9.8981 2.28601 9.80498 2.3459 9.71729 2.41317C9.32164 2.7167 9.10063 3.20155 8.65861 4.17126L8.05292 5.5",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"},null,-1))),F=l((()=>(0,o.Lk)("path",{d:"M9.5 16.5L9.5 10.5",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"},null,-1))),L=l((()=>(0,o.Lk)("path",{d:"M14.5 16.5L14.5 10.5",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round"},null,-1))),x=[v,$,F,L],_={class:"kb-card-description"},K={class:"kb-card-footer"},y={class:"create-time"},D={style:{"text-align":"right","margin-top":"20px"}},R={class:"file-container"},T={class:"file-card"},V=l((()=>(0,o.Lk)("img",{src:i,alt:"File Icon",class:"file-icon"},null,-1))),I={class:"file-details"},S={class:"file-title"},P=["onClick"],U={class:"file-info"},A={class:"upload-time"},E={class:"file-size"},B={key:0,class:"chunks-preview"},M={class:"chunks-grid"},X=["onClick"],z={class:"chunk-square-content"},q={key:0,class:"chunk-number"},j={class:"chunk-expanded-header"},W={class:"chunk-length"},H={class:"chunk-expanded-content"},Z={class:"upload-card",style:{"border-bottom":"none"}},G={class:"el-upload__text"},Q={class:"upload-progress-text"},N={class:"el-upload__tip"};function O(e,t,s,i,l,b){const g=(0,o.g2)("Plus"),v=(0,o.g2)("el-icon"),$=(0,o.g2)("el-col"),F=(0,o.g2)("el-tooltip"),L=(0,o.g2)("el-row"),O=(0,o.g2)("el-input"),J=(0,o.g2)("el-form-item"),Y=(0,o.g2)("el-form"),ee=(0,o.g2)("el-button"),te=(0,o.g2)("CustomDialog"),se=(0,o.g2)("el-scrollbar"),oe=(0,o.g2)("upload-filled"),ae=(0,o.g2)("el-progress"),ie=(0,o.g2)("el-upload");return(0,o.uX)(),(0,o.CE)("div",null,[(0,o.bF)(L,{gutter:24,justify:"center",style:{"margin-left":"0","margin-right":"0"}},{default:(0,o.k6)((()=>[(0,o.bF)($,{md:22,sm:22,xs:22},{default:(0,o.k6)((()=>[(0,o.Lk)("div",n,[(0,o.Lk)("h4",null,(0,a.v_)(e.$t("Kb.header")),1),(0,o.Lk)("div",r,[(0,o.Lk)("span",null,(0,a.v_)(e.$t("Kb.stats.totalFiles"))+": "+(0,a.v_)(b.totalFiles),1),(0,o.Lk)("span",null,(0,a.v_)(e.$t("Kb.stats.totalChunks"))+": "+(0,a.v_)(b.totalChunks),1)])]),(0,o.bF)(L,{gutter:24},{default:(0,o.k6)((()=>[(0,o.bF)($,{xs:24,sm:12,md:8,lg:8,xl:6},{default:(0,o.k6)((()=>[(0,o.Lk)("div",{class:"kb-card dashed-border create-kb-card",onClick:t[0]||(t[0]=e=>l.createRepoDialogVisible=!0)},[(0,o.Lk)("div",d,[(0,o.bF)(v,{size:40},{default:(0,o.k6)((()=>[(0,o.bF)(g)])),_:1}),(0,o.Lk)("span",c,(0,a.v_)(this.$t("Kb.createRepo.title")),1)])])])),_:1}),((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(b.repos,(e=>((0,o.uX)(),(0,o.Wv)($,{xs:24,sm:12,md:8,lg:8,xl:6,key:e.repoId},{default:(0,o.k6)((()=>[(0,o.Lk)("div",p,[(0,o.Lk)("div",u,[(0,o.Lk)("div",h,[(0,o.Lk)("span",k,(0,a.v_)(e.name),1),(0,o.Lk)("div",m,[(0,o.bF)(F,{content:"管理",placement:"top"},{default:(0,o.k6)((()=>[((0,o.uX)(),(0,o.CE)("svg",{class:"action-icon",onClick:t=>b.openRepo(e),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none"},f,8,C))])),_:2},1024),(0,o.bF)(F,{content:"删除",placement:"top"},{default:(0,o.k6)((()=>[((0,o.uX)(),(0,o.CE)("svg",{class:"action-icon delete",onClick:t=>b.deleteRepo(e.repoId),xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",width:"16",height:"16",fill:"none"},x,8,w))])),_:2},1024)])])]),(0,o.Lk)("p",_,(0,a.v_)(e.description),1),(0,o.Lk)("div",K,[(0,o.Lk)("span",y,(0,a.v_)(this.$t("Kb.repoDetail.createTime"))+": "+(0,a.v_)(e.createTime),1)])])])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1}),(0,o.bF)(te,{modelValue:l.createRepoDialogVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>l.createRepoDialogVisible=e),title:e.$t("Kb.createRepo.title")},{default:(0,o.k6)((()=>[(0,o.bF)(Y,{model:l.newKbForm,"label-width":"100px",rules:l.rules,ref:"newKbForm"},{default:(0,o.k6)((()=>[(0,o.bF)(J,{label:e.$t("Kb.createRepo.name"),prop:"name"},{default:(0,o.k6)((()=>[(0,o.bF)(O,{modelValue:l.newKbForm.name,"onUpdate:modelValue":t[1]||(t[1]=e=>l.newKbForm.name=e),maxlength:"10","show-word-limit":""},null,8,["modelValue"])])),_:1},8,["label"]),(0,o.bF)(J,{label:e.$t("Kb.createRepo.description"),prop:"description"},{default:(0,o.k6)((()=>[(0,o.bF)(O,{type:"textarea",modelValue:l.newKbForm.description,"onUpdate:modelValue":t[2]||(t[2]=e=>l.newKbForm.description=e)},null,8,["modelValue"])])),_:1},8,["label"])])),_:1},8,["model","rules"]),(0,o.Lk)("div",D,[(0,o.bF)(ee,{type:"primary",onClick:b.createRepo},{default:(0,o.k6)((()=>[(0,o.eW)((0,a.v_)(this.$t("Common.confirm")),1)])),_:1},8,["onClick"]),(0,o.bF)(ee,{onClick:t[3]||(t[3]=e=>l.createRepoDialogVisible=!1)},{default:(0,o.k6)((()=>[(0,o.eW)((0,a.v_)(this.$t("Common.cancel")),1)])),_:1})])])),_:1},8,["modelValue","title"]),(0,o.bF)(te,{modelValue:l.repoDialogVisible,"onUpdate:modelValue":t[5]||(t[5]=e=>l.repoDialogVisible=e),title:`${l.activeRepo?.name||""} - ${this.$t("Kb.repoDetail.fileList")}`},{default:(0,o.k6)((()=>[(0,o.Lk)("div",R,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(b.files,(t=>((0,o.uX)(),(0,o.CE)("div",T,[V,(0,o.Lk)("div",I,[(0,o.Lk)("div",S,[(0,o.eW)((0,a.v_)(t.name)+" ",1),(0,o.bF)(ee,{type:"text",size:"small",onClick:e=>b.toggleChunks(t)},{default:(0,o.k6)((()=>[(0,o.eW)((0,a.v_)(t.showChunks?this.$t("Kb.repoDetail.hideChunks"):this.$t("Kb.repoDetail.showChunks")),1)])),_:2},1032,["onClick"]),(0,o.Lk)("button",{class:"delete-btn",onClick:e=>b.delFile(t.fileId)},"✕",8,P)]),(0,o.Lk)("div",U,[(0,o.Lk)("span",A,(0,a.v_)(this.$t("Kb.repoDetail.uploadTime"))+": "+(0,a.v_)(t.createTime),1),(0,o.Lk)("span",E,(0,a.v_)(this.$t("Kb.repoDetail.fileSize"))+": "+(0,a.v_)(b.formatFileSize(t.size)),1)]),t.showChunks?((0,o.uX)(),(0,o.CE)("div",B,[(0,o.Lk)("div",M,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(t.list,((s,i)=>((0,o.uX)(),(0,o.CE)("div",{key:i,class:(0,a.C4)(["chunk-square",{expanded:b.isChunkExpanded(t.fileId,i)}]),onClick:e=>b.toggleChunkContent(t.fileId,i)},[(0,o.Lk)("div",z,[b.isChunkExpanded(t.fileId,i)?((0,o.uX)(),(0,o.CE)(o.FK,{key:1},[(0,o.Lk)("div",j,[(0,o.Lk)("span",null,(0,a.v_)(e.$t("Kb.repoDetail.section"))+" "+(0,a.v_)(i+1),1),(0,o.Lk)("span",W,(0,a.v_)(s.content.length)+" "+(0,a.v_)(e.$t("Kb.repoDetail.characters")),1)]),(0,o.Lk)("div",H,[(0,o.bF)(se,{height:"200px"},{default:(0,o.k6)((()=>[(0,o.eW)((0,a.v_)(s.content),1)])),_:2},1024)])],64)):((0,o.uX)(),(0,o.CE)("div",q,(0,a.v_)(i+1),1))])],10,X)))),128))])])):(0,o.Q3)("",!0)])])))),256)),(0,o.Lk)("div",Z,[(0,o.bF)(ie,{class:"upload-button",drag:"","auto-upload":!0,"http-request":b.handleLocalUpload,multiple:"","before-upload":b.beforeUpload,"show-file-list":!1,accept:".pdf,.doc,.docx,.txt"},{tip:(0,o.k6)((()=>[(0,o.Lk)("div",N,(0,a.v_)(e.$t("Kb.repoDetail.uploadLimitTip")),1)])),default:(0,o.k6)((()=>[l.isUploading?((0,o.uX)(),(0,o.CE)(o.FK,{key:1},[(0,o.bF)(ae,{type:"circle",percentage:l.uploadProgress,status:100===l.uploadProgress?"success":""},null,8,["percentage","status"]),(0,o.Lk)("div",Q,(0,a.v_)(l.uploadStatusText),1)],64)):((0,o.uX)(),(0,o.CE)(o.FK,{key:0},[(0,o.bF)(v,{class:"el-icon--upload"},{default:(0,o.k6)((()=>[(0,o.bF)(oe)])),_:1}),(0,o.Lk)("div",G,(0,a.v_)(e.$t("Kb.repoDetail.uploadTip")),1)],64))])),_:1},8,["http-request","before-upload"])])])])),_:1},8,["modelValue","title"])])}s(44114),s(16573),s(78100),s(77936),s(37467),s(44732),s(79577);var J=s(94086),Y=s(46387),ee={addRepo(e){let t=Y.A.state.app.kb;t.list.push(e),Y.A.dispatch("setKb",t)},delRepo(e){let t=Y.A.state.app.kb;t.list=t.list.filter((t=>t.repoId!==e)),Y.A.dispatch("setKb",t)},updRepo(e,t){let s=Y.A.state.app.kb,o=s.list.findIndex((t=>t.id===e));-1!==o&&(s.list[o]=t,Y.A.dispatch("setKb",s))},addFile(e,t){let s=Y.A.state.app.kb;console.log(s);let o=s.findRepository(e);o&&(o.addFile(t),Y.A.dispatch("setKb",s))},delFile(e,t){let s=Y.A.state.app.kb,o=s.findRepository(e);o&&(o.removeFile(t),Y.A.dispatch("setKb",s))}},te=s(77402);const se=(0,te.useDefault)(new te.Segment);var oe={name:"Kb",data(){return{activeRepo:null,createRepoDialogVisible:!1,newKbForm:{name:"",description:""},rules:{name:[{required:!0,message:this.$t("Kb.createRepo.nameRequired"),trigger:"blur"}],description:[{required:!0,message:this.$t("Kb.createRepo.descriptionRequired"),trigger:"blur"}]},repoDialogVisible:!1,uploadProgress:0,isUploading:!1,uploadStatusText:"",progressTimer:null,fileChunksVisibility:{},expandedChunks:{}}},computed:{repos(){return this.$store.state.app.kb.list},files(){return this.activeRepo?.list||[]},chunkSize(){return this.$store.state.setting.chunk_size},totalFiles(){return this.$store.state.app.kb.statistics.totalFiles},totalChunks(){return this.$store.state.app.kb.statistics.totalChunks}},created(){},methods:{createRepo(){this.$refs.newKbForm.validate((e=>{if(e){const e=new J.LN(Date.now(),this.newKbForm.name,(new Date).toLocaleString(),this.newKbForm.description,[]);ee.addRepo(e),this.createRepoDialogVisible=!1,this.newKbForm={name:"",description:""},this.$refs.newKbForm.resetFields()}}))},openRepo(e){this.activeRepo=e,this.repoDialogVisible=!0},deleteRepo(e){this.$confirm(this.$t("Common.confirmDelete"),this.$t("Common.warn"),{confirmButtonText:this.$t("Common.confirm"),cancelButtonText:this.$t("Common.cancel"),type:"warning"}).then((()=>{ee.delRepo(e),this.$notify({title:this.$t("Common.success"),message:this.$t("Common.deleteSuccess"),type:"success"})})).catch((()=>{}))},beforeUpload(e){const t=1024*this.$store.state.setting.kb_file_size*1024;return!(e.size>t)||(this.$notify({title:this.$t("Common.error"),message:this.$t("Common.failed"),type:"error"}),!1)},async handleLocalUpload(e){const t=e.file;this.isUploading=!0,this.uploadProgress=0,this.uploadStatusText=this.$t("Kb.repoDetail.preparing");try{const e=setInterval((()=>{if(this.uploadProgress<90){const e=90-this.uploadProgress,t=Math.max(1,Math.floor(.2*e));this.uploadProgress+=t,this.uploadStatusText=this.$t("Kb.repoDetail.processing")}}),1e3),s=await this.readFileContent(t);if(!s||""===s.trim())return this.$notify({title:this.$t("Common.warn"),message:this.$t("Kb.repoDetail.noContent"),type:"warning"}),this.isUploading=!1,this.uploadProgress=0,void(this.uploadStatusText="");const o=this.splitContentIntoChunks(s,this.chunkSize);clearInterval(e);const a=new J.ZH(Date.now(),t.name,(new Date).toLocaleString(),t.name.split(".").pop().toLowerCase(),"",t.size,o.map((e=>new J.AA(Date.now(),e,se.doSegment(e.toLowerCase()).map((e=>e.w))))));ee.addFile(this.activeRepo.repoId,a),this.uploadProgress=100,this.uploadStatusText=this.$t("Kb.repoDetail.uploadComplete"),this.$notify({title:this.$t("Common.success"),message:this.$t("Kb.repoDetail.uploadComplete"),type:"success"}),setTimeout((()=>{this.isUploading=!1,this.uploadProgress=0,this.uploadStatusText=""}),1500)}catch(s){console.error("文件上传失败:",s),this.uploadStatusText=this.$t("Kb.repoDetail.uploadFailed"),this.$notify({title:this.$t("Common.error"),message:this.$t("Kb.repoDetail.uploadFailed"),type:"error"}),setTimeout((()=>{this.isUploading=!1,this.uploadProgress=0,this.uploadStatusText=""}),1500)}},async readFileContent(e){const t=e.name.split(".").pop().toLowerCase();switch(t){case"pdf":return await this.readPdfContent(e);case"doc":case"docx":return await this.readDocContent(e);case"txt":return await this.readTxtContent(e);default:throw new Error("不支持的文件格式")}},readTxtContent(e){return new Promise(((t,s)=>{const o=new FileReader;o.onload=e=>t(e.target.result),o.onerror=e=>s(e),o.readAsText(e,"UTF-8")}))},async readPdfContent(e){return new Promise(((t,o)=>{const a=new FileReader;a.onload=async e=>{try{const o=new Uint8Array(e.target.result),a=await s.e(279).then(s.t.bind(s,5279,23));a.GlobalWorkerOptions.workerSrc=`//cdnjs.cloudflare.com/ajax/libs/pdf.js/${a.version}/pdf.worker.min.js`;const i=a.getDocument(o),l=await i.promise;let n="";for(let e=1;e<=l.numPages;e++){const t=await l.getPage(e),s=await t.getTextContent(),o=s.items.map((e=>e.str)).join(" ");n+=o+"\n"}t(n)}catch(a){o(a)}},a.onerror=o,a.readAsArrayBuffer(e)}))},async readDocContent(e){const t=await s.e(195).then(s.t.bind(s,21195,19)),o=await e.arrayBuffer(),a=await t.extractRawText({arrayBuffer:o});return a.value},async delFile(e){try{await this.$confirm(this.$t("Kb.repoDetail.deleteFile.confirm"),this.$t("Common.warn"),{confirmButtonText:this.$t("Common.confirm"),cancelButtonText:this.$t("Common.cancel"),type:"warning"}),ee.delFile(this.activeRepo.repoId,e),this.$notify({title:this.$t("Common.success"),message:this.$t("Kb.repoDetail.deleteFile.success"),type:"success"})}catch(t){"cancel"!==t&&(console.error("文件删除失败:",t),this.$notify({title:this.$t("Common.error"),message:this.$t("Kb.repoDetail.deleteFile.failed"),type:"error"}))}},formatFileSize(e){if(!e)return"0 B";const t=1024,s=["B","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,o)).toFixed(2))+" "+s[o]},splitContentIntoChunks(e,t){const s=[];let o="";const a=e.split(/[。！？.!?]/);for(const i of a)(o+i).length>t?(o&&s.push(o.trim()),o=i):o+=i;return o&&s.push(o.trim()),s},toggleChunks(e){e.showChunks=!e.showChunks},toggleChunkContent(e,t){const s=`${e}-${t}`;this.expandedChunks[s]=!this.expandedChunks[s]},isChunkExpanded(e,t){const s=`${e}-${t}`;return this.expandedChunks[s]}}},ae=s(71241);const ie=(0,ae.A)(oe,[["render",O],["__scopeId","data-v-4ae53a5a"]]);var le=ie}}]);
//# sourceMappingURL=813.910a0e0f.js.map